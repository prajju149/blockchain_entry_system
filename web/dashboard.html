<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blockchain Entry/Exit System - Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #0066cc;
      --primary-dark: #0052a3;
      --success: #28a745;
      --error: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
      --light: #f8f9fa;
      --dark: #212529;
      --border: #e0e0e0;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
      --shadow-lg: 0 8px 16px rgba(0,0,0,0.15);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--dark);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
      color: white;
      animation: slideDown 0.6s ease-out;
    }

    header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      letter-spacing: 1px;
    }

    header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
      animation: fadeIn 0.6s ease-out 0.2s both;
    }

    .tab-btn {
      padding: 12px 24px;
      border: none;
      background: rgba(255,255,255,0.2);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: var(--transition);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255,255,255,0.3);
    }

    .tab-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .tab-btn.active {
      background: white;
      color: var(--primary);
      box-shadow: var(--shadow-lg);
    }

    .content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--shadow);
      transition: var(--transition);
      animation: fadeInUp 0.6s ease-out;
      border: 1px solid var(--border);
    }

    .card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-4px);
    }

    .card.hidden {
      display: none;
    }

    .card h2 {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
      font-size: 0.95rem;
    }

    input[type="text"],
    input[type="file"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
      transition: var(--transition);
      font-family: inherit;
    }

    input[type="text"]:focus,
    input[type="file"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }

    input[type="file"] {
      padding: 10px;
      cursor: pointer;
    }

    input[type="file"]::file-selector-button {
      padding: 8px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }

    input[type="file"]::file-selector-button:hover {
      background: var(--primary-dark);
    }

    .button-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-width: fit-content;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      box-shadow: var(--shadow);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background: var(--light);
      color: var(--dark);
      border: 2px solid var(--border);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--border);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .status {
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      animation: slideIn 0.4s ease-out;
      border-left: 4px solid;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border-left-color: #28a745;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border-left-color: #dc3545;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border-left-color: #17a2b8;
    }

    .status.loading {
      background: #fff3cd;
      color: #856404;
      border-left-color: #ffc107;
    }

    .status::before {
      font-size: 1.3rem;
      flex-shrink: 0;
    }

    .status.success::before { content: '‚úì'; }
    .status.error::before { content: '‚úï'; }
    .status.info::before { content: '‚Ñπ'; }
    .status.loading::before { content: '‚ü≥'; animation: spin 1s linear infinite; }

    .output {
      background: #f8f9fa;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      line-height: 1.5;
    }

    .output code {
      color: var(--dark);
    }

    .badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-right: 8px;
    }

    .badge.primary {
      background: rgba(0, 102, 204, 0.2);
      color: var(--primary);
    }

    .badge.success {
      background: rgba(40, 167, 69, 0.2);
      color: var(--success);
    }

    .badge.error {
      background: rgba(220, 53, 69, 0.2);
      color: var(--error);
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .stat-item {
      background: linear-gradient(135deg, rgba(0, 102, 204, 0.1), rgba(0, 102, 204, 0.05));
      padding: 16px;
      border-radius: 8px;
      border: 1px solid rgba(0, 102, 204, 0.2);
      text-align: center;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary);
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
      margin-top: 8px;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0,0,0,0.1);
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .resident-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .resident-card {
      background: linear-gradient(135deg, #f5f7fa, #ffffff);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      transition: var(--transition);
    }

    .resident-card:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow);
    }

    .resident-name {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 8px;
    }

    .resident-room {
      color: #666;
      font-size: 0.9rem;
    }

    .mode-indicator {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 8px;
    }

    .mode-qr {
      background: rgba(0, 102, 204, 0.2);
      color: var(--primary);
    }

    .mode-face {
      background: rgba(40, 167, 69, 0.2);
      color: var(--success);
    }

    .mode-voice {
      background: rgba(255, 193, 7, 0.2);
      color: #ff9800;
    }

    @media (max-width: 768px) {
      header h1 {
        font-size: 1.8rem;
      }

      .content {
        grid-template-columns: 1fr;
      }

      .tabs {
        flex-direction: column;
      }

      .tab-btn {
        width: 100%;
      }
    }

    .success-animation {
      animation: successPulse 0.6s ease-out;
    }

    @keyframes successPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üîê Blockchain Identity System</h1>
      <p>Secure Entry/Exit Authentication Dashboard</p>
    </header>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('register')">üìù Register</button>
      <button class="tab-btn" onclick="switchTab('residents')">üë• Residents</button>
      <button class="tab-btn" onclick="switchTab('scan')">üîç Scan</button>
      <button class="tab-btn" onclick="switchTab('ledger')">üìã Ledger</button>
    </div>

    <div class="content">
      <!-- Register Tab -->
      <div class="card" id="register-tab">
        <h2>üìù Register New Resident</h2>
        <form id="regForm">
          <div class="form-group">
            <label>Full Name *</label>
            <input type="text" name="name" required placeholder="Enter resident name">
          </div>
          <div class="form-group">
            <label>Room Number *</label>
            <input type="text" name="room" required placeholder="e.g., 101, 202">
          </div>
          <div class="form-group">
            <label>Email Address</label>
            <input type="email" name="email" placeholder="resident@example.com">
          </div>
          <div class="form-group">
            <label>Phone Number</label>
            <input type="text" name="phone" placeholder="+1 (555) 123-4567">
          </div>
          <div class="form-group">
            <label>Address</label>
            <input type="text" name="address" placeholder="Street address">
          </div>
          <div class="form-group">
            <label>Floor</label>
            <input type="text" name="floor" placeholder="e.g., 1st, 2nd, 3rd">
          </div>
          <div class="form-group">
            <label>Move-in Date</label>
            <input type="date" name="moveInDate">
          </div>
          <div class="form-group">
            <label>Occupation</label>
            <input type="text" name="occupation" placeholder="e.g., Engineer, Student">
          </div>
          <div class="form-group">
            <label>Emergency Contact</label>
            <input type="text" name="emergencyContact" placeholder="Contact name and phone">
          </div>
          <div class="form-group">
            <label>Photo (Face Recognition)</label>
            <input type="file" name="photo" accept="image/*">
          </div>
          <div class="form-group">
            <label>Voice Sample (WAV)</label>
            <input type="file" name="voice" accept="audio/wav,audio/*">
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" name="agreeTerms" required>
              I agree to the terms and conditions
            </label>
          </div>
          <div class="button-group">
            <button type="submit" class="btn-primary" id="btnRegister">
              <span>‚úì</span> Register Resident
            </button>
            <button type="reset" class="btn-secondary">
              <span>‚Üª</span> Clear Form
            </button>
          </div>
        </form>
        <div id="regStatus"></div>
        <div id="registrationInfo" style="display: none; margin-top: 20px;">
          <div style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05)); padding: 16px; border-radius: 8px; border-left: 4px solid var(--success);">
            <h3 style="color: var(--success); margin-bottom: 12px;">‚úÖ Registration Complete</h3>
            <div id="regDetails"></div>
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(0,0,0,0.1);">
              <p style="font-size: 0.9rem; color: #666; margin-bottom: 12px;"><strong>Next Steps:</strong></p>
              <ul style="margin-left: 20px; color: #666; font-size: 0.9rem;">
                <li>‚úì QR Code has been generated</li>
                <li>‚úì Biometric data saved (if provided)</li>
                <li>‚úì Resident added to blockchain</li>
                <li>‚Üí Use Scan tab to test entry/exit</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="output" id="regOut"></div>
      </div>

      <!-- Residents Tab -->
      <div class="card hidden" id="residents-tab">
        <h2>üë• Registered Residents</h2>
        <div class="button-group">
          <button class="btn-primary" id="btnLoad">
            <span>‚ü≥</span> Refresh List
          </button>
        </div>
        <div id="resStatus"></div>
        <div class="stats" id="resStats"></div>
        <div class="resident-list" id="resList"></div>
      </div>

      <!-- Scan Tab -->
      <div class="card hidden" id="scan-tab">
        <h2>üîç Entry/Exit Scan</h2>
        
        <!-- QR Scanner Mode -->
        <div id="qrScannerSection">
          <div class="form-group">
            <label style="color: var(--success); font-weight: 700;">üì± Live QR Code Scanner (Click Camera Icon)</label>
            <button type="button" class="btn-primary" id="btnToggleCamera" style="width: 100%; margin-bottom: 12px;">
              <span>üì∑</span> Start Camera
            </button>
          </div>
          
          <div id="cameraContainer" style="display: none; margin-bottom: 16px;">
            <video id="cameraFeed" style="width: 100%; border-radius: 8px; border: 2px solid var(--primary); max-height: 400px; background: #000;"></video>
            <canvas id="qrCanvas" style="display: none;"></canvas>
            <div id="scannerStatus" style="text-align: center; margin-top: 12px; font-size: 0.9rem; color: #666;">
              Point camera at QR code...
            </div>
          </div>

          <div style="text-align: center; margin: 20px 0; color: #999;">
            <div style="border-top: 2px solid var(--border); padding-top: 20px; color: #999;">OR enter manually below</div>
          </div>
        </div>

        <div class="form-group">
          <label>Resident ID (optional - auto-filled from QR)</label>
          <input type="text" id="scanRid" placeholder="Leave blank for QR lookup or enter manually">
        </div>
        <div class="form-group">
          <label>Scan Mode</label>
          <select id="scanMode">
            <option value="qr">üî≤ QR Code</option>
            <option value="face">üòä Face Recognition</option>
            <option value="voice">üé§ Voice Recognition</option>
          </select>
        </div>
        <div class="form-group" id="photoGroup" style="display:none">
          <label>Upload Photo</label>
          <input type="file" id="scanPhoto" accept="image/*">
        </div>
        <div class="form-group" id="audioGroup" style="display:none">
          <label>Upload Audio</label>
          <input type="file" id="scanAudio" accept="audio/wav,audio/*">
        </div>
        <div class="button-group">
          <button class="btn-primary" id="btnScan">
            <span>‚ñ∂</span> Send Scan
          </button>
        </div>
        <div id="scanStatus"></div>
        <div class="output" id="scanOut"></div>
      </div>

      <!-- Ledger Tab -->
      <div class="card hidden" id="ledger-tab">
        <h2>üìã Blockchain Ledger</h2>
        <div class="button-group">
          <button class="btn-primary" id="btnLedger">
            <span>‚ü≥</span> Load Ledger
          </button>
        </div>
        <div id="ledgerStatus"></div>
        <div class="stats" id="ledgerStats"></div>
        <div class="output" id="ledgerOut"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    const API_BASE = window.location.origin;
    let cameraStream = null;
    let scanningActive = false;

    // Tab switching
    function switchTab(tabName) {
      // Stop camera when switching tabs
      if (cameraStream) {
        stopCamera();
      }
      document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabName + '-tab').classList.remove('hidden');
      event.target.classList.add('active');
    }

    // ============ QR CODE SCANNER ============
    const btnToggleCamera = document.getElementById('btnToggleCamera');
    const cameraContainer = document.getElementById('cameraContainer');
    const cameraFeed = document.getElementById('cameraFeed');
    const qrCanvas = document.getElementById('qrCanvas');
    const scannerStatus = document.getElementById('scannerStatus');

    btnToggleCamera.addEventListener('click', async () => {
      if (cameraStream) {
        stopCamera();
      } else {
        await startCamera();
      }
    });

    async function startCamera() {
      try {
        btnToggleCamera.disabled = true;
        btnToggleCamera.innerHTML = '<span>‚è≥</span> Starting Camera...';

        // Request camera access with optimal constraints
        const constraints = {
          video: {
            facingMode: 'environment', // Back camera on mobile
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        };

        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        cameraFeed.srcObject = cameraStream;
        cameraContainer.style.display = 'block';
        btnToggleCamera.innerHTML = '<span>üõë</span> Stop Camera';
        btnToggleCamera.style.background = 'var(--error)';
        btnToggleCamera.disabled = false;

        scanningActive = true;
        scanQRCode();
      } catch (error) {
        console.error('Camera error:', error);
        let msg = 'Camera access denied';
        if (error.name === 'NotAllowedError') msg = 'Please allow camera access';
        if (error.name === 'NotFoundError') msg = 'No camera found';
        if (error.name === 'NotReadableError') msg = 'Camera is already in use';
        showStatus('scanStatus', `‚ùå ${msg}`, 'error');
        btnToggleCamera.disabled = false;
      }
    }

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
      cameraContainer.style.display = 'none';
      btnToggleCamera.innerHTML = '<span>üì∑</span> Start Camera';
      btnToggleCamera.style.background = '';
      scanningActive = false;
    }

    function scanQRCode() {
      if (!scanningActive) return;

      const canvas = qrCanvas;
      const ctx = canvas.getContext('2d');

      // Set canvas size to match video
      canvas.width = cameraFeed.videoWidth;
      canvas.height = cameraFeed.videoHeight;

      // Draw video frame to canvas
      ctx.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);

      // Get image data and scan for QR codes
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);

      if (code) {
        // QR code detected!
        const qrData = code.data;
        console.log('QR Code detected:', qrData);
        
        // Auto-fill resident ID
        document.getElementById('scanRid').value = qrData;
        
        // Visual feedback
        scannerStatus.innerHTML = `‚úÖ QR Scanned: <strong>${qrData.substring(0, 12)}...</strong>`;
        scannerStatus.style.color = 'var(--success)';
        
        // Optional: Auto-submit scan
        setTimeout(() => {
          if (confirm('Scan QR code for this resident?')) {
            document.getElementById('btnScan').click();
            stopCamera();
          }
        }, 500);
        
        return;
      }

      // Scanning feedback
      scannerStatus.innerHTML = '‚ü≥ Scanning... Point camera at QR code';
      scannerStatus.style.color = '#666';

      // Continue scanning
      requestAnimationFrame(scanQRCode);
    }

    // ============ UTILITY FUNCTIONS ============
    function showStatus(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      el.innerHTML = `<div class="status ${type}">${message}</div>`;
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function formatJSON(data) {
      return JSON.stringify(data, null, 2);
    }

    // Scan mode toggle
    document.getElementById('scanMode').addEventListener('change', function() {
      document.getElementById('photoGroup').style.display = this.value === 'face' ? 'block' : 'none';
      document.getElementById('audioGroup').style.display = this.value === 'voice' ? 'block' : 'none';
    });

    // ============ REGISTER RESIDENT ============
    document.getElementById('regForm').addEventListener('submit', async e => {
      e.preventDefault();
      const btn = document.getElementById('btnRegister');
      btn.disabled = true;
      showStatus('regStatus', 'Processing registration...', 'loading');

      try {
        let f = new FormData(e.target);
        let res = await fetch(`${API_BASE}/api/register`, {method: 'POST', body: f});
        let j = await res.json();

        if (res.ok) {
          const resident = j.resident;
          
          // Show success message
          showStatus('regStatus', `‚úÖ Resident "${resident.name}" registered successfully!`, 'success');
          
          // Display registration details
          const detailsHTML = `
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
              <tr style="border-bottom: 1px solid rgba(0,0,0,0.1);">
                <td style="padding: 8px; font-weight: 600; color: var(--primary);">Resident ID:</td>
                <td style="padding: 8px; font-family: monospace; color: #666;">${resident.id}</td>
              </tr>
              <tr style="border-bottom: 1px solid rgba(0,0,0,0.1);">
                <td style="padding: 8px; font-weight: 600; color: var(--primary);">Name:</td>
                <td style="padding: 8px; color: #333;">${resident.name}</td>
              </tr>
              <tr style="border-bottom: 1px solid rgba(0,0,0,0.1);">
                <td style="padding: 8px; font-weight: 600; color: var(--primary);">Room:</td>
                <td style="padding: 8px; color: #333;">${resident.room}</td>
              </tr>
              ${resident.email ? `
              <tr style="border-bottom: 1px solid rgba(0,0,0,0.1);">
                <td style="padding: 8px; font-weight: 600; color: var(--primary);">Email:</td>
                <td style="padding: 8px; color: #333;">${resident.email}</td>
              </tr>
              ` : ''}
              ${resident.phone ? `
              <tr style="border-bottom: 1px solid rgba(0,0,0,0.1);">
                <td style="padding: 8px; font-weight: 600; color: var(--primary);">Phone:</td>
                <td style="padding: 8px; color: #333;">${resident.phone}</td>
              </tr>
              ` : ''}
              ${resident.room ? `
              <tr style="border-bottom: 1px solid rgba(0,0,0,0.1);">
                <td style="padding: 8px; font-weight: 600; color: var(--primary);">Biometrics:</td>
                <td style="padding: 8px;">
                  ${resident.photo_fp ? '<span class="badge success">üì∑ Face</span>' : ''}
                  ${resident.voice_fp ? '<span class="badge success">üé§ Voice</span>' : ''}
                  ${!resident.photo_fp && !resident.voice_fp ? '<span style="color: #999;">None</span>' : ''}
                </td>
              </tr>
              ` : ''}
              <tr>
                <td style="padding: 8px; font-weight: 600; color: var(--primary);">Registered:</td>
                <td style="padding: 8px; color: #333;">${new Date(resident.created * 1000).toLocaleString()}</td>
              </tr>
            </table>
          `;
          
          document.getElementById('regDetails').innerHTML = detailsHTML;
          document.getElementById('registrationInfo').style.display = 'block';
          
          // Show API response
          document.getElementById('regOut').innerHTML = `<code>${formatJSON(j)}</code>`;
          
          // Reset form
          document.getElementById('regForm').reset();
          document.getElementById('regForm').parentElement.classList.add('success-animation');
          
          // Scroll to success message
          document.getElementById('registrationInfo').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
          showStatus('regStatus', `‚ùå Error: ${j.error}`, 'error');
          document.getElementById('regOut').innerHTML = `<code>${formatJSON(j)}</code>`;
          document.getElementById('registrationInfo').style.display = 'none';
        }
      } catch (err) {
        showStatus('regStatus', `‚ùå Network error: ${err.message}`, 'error');
        document.getElementById('registrationInfo').style.display = 'none';
      } finally {
        btn.disabled = false;
      }
    });

    // ============ LOAD RESIDENTS ============
    document.getElementById('btnLoad').addEventListener('click', async () => {
      const btn = event.target;
      btn.disabled = true;
      showStatus('resStatus', 'Loading residents...', 'loading');

      try {
        let res = await fetch(`${API_BASE}/api/residents`);
        let j = await res.json();

        if (res.ok) {
          const residents = j.residents || [];
          const count = residents.length;
          showStatus('resStatus', `‚úÖ Loaded ${count} resident(s)`, 'success');

          // Show stats
          document.getElementById('resStats').innerHTML = `
            <div class="stat-item">
              <div class="stat-number">${count}</div>
              <div class="stat-label">Total Residents</div>
            </div>
          `;

          // Display residents
          if (residents.length > 0) {
            document.getElementById('resList').innerHTML = residents.map(r => `
              <div class="resident-card">
                <div class="resident-name">${r.name}</div>
                <div class="resident-room">üè† Room ${r.room}</div>
                <div class="resident-room">üÜî ${r.id.substring(0, 8)}...</div>
                ${r.photo_fp ? '<span class="mode-indicator mode-face">Face ‚úì</span>' : ''}
                ${r.voice_fp ? '<span class="mode-indicator mode-voice">Voice ‚úì</span>' : ''}
              </div>
            `).join('');
          } else {
            document.getElementById('resList').innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">No residents registered yet</p>';
          }
        } else {
          showStatus('resStatus', `‚ùå Error loading residents`, 'error');
        }
      } catch (err) {
        showStatus('resStatus', `‚ùå Network error: ${err.message}`, 'error');
      } finally {
        btn.disabled = false;
      }
    });

    // ============ FILE TO BASE64 ============
    async function fileToBase64(file) {
      return new Promise((ok, err) => {
        const r = new FileReader();
        r.onload = () => ok(r.result.split(',')[1]);
        r.onerror = err;
        r.readAsDataURL(file);
      });
    }

    // ============ SEND SCAN ============
    document.getElementById('btnScan').addEventListener('click', async () => {
      const btn = event.target;
      btn.disabled = true;
      showStatus('scanStatus', 'Processing scan...', 'loading');

      try {
        const rid = document.getElementById('scanRid').value;
        const mode = document.getElementById('scanMode').value;
        const photo = document.getElementById('scanPhoto').files[0];
        const audio = document.getElementById('scanAudio').files[0];

        if (!rid && mode !== 'qr') {
          showStatus('scanStatus', '‚ùå Resident ID required for face/voice', 'error');
          btn.disabled = false;
          return;
        }
        if (mode === 'face' && !photo) {
          showStatus('scanStatus', '‚ùå Photo required', 'error');
          btn.disabled = false;
          return;
        }
        if (mode === 'voice' && !audio) {
          showStatus('scanStatus', '‚ùå Audio required', 'error');
          btn.disabled = false;
          return;
        }

        let payload = {mode};
        if (rid) payload.resident_id = rid;
        if (mode === 'face' && photo) payload.photo_b64 = await fileToBase64(photo);
        if (mode === 'voice' && audio) payload.audio_b64 = await fileToBase64(audio);

        let res = await fetch(`${API_BASE}/api/scan`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        let j = await res.json();

        document.getElementById('scanOut').innerHTML = `<code>${formatJSON(j)}</code>`;

        if (res.ok && j.ok) {
          showStatus('scanStatus', `‚úÖ ACCESS GRANTED - ${j.event.name} (${j.event.mode})`, 'success');
        } else if (res.ok && !j.ok) {
          showStatus('scanStatus', `‚ùå ACCESS DENIED - Biometric mismatch`, 'error');
        } else {
          showStatus('scanStatus', `‚ùå Error: ${j.error}`, 'error');
        }
      } catch (err) {
        showStatus('scanStatus', `‚ùå Network error: ${err.message}`, 'error');
      } finally {
        btn.disabled = false;
      }
    });

    // ============ LOAD LEDGER ============
    document.getElementById('btnLedger').addEventListener('click', async () => {
      const btn = event.target;
      btn.disabled = true;
      showStatus('ledgerStatus', 'Loading ledger...', 'loading');

      try {
        let res = await fetch(`${API_BASE}/api/ledger`);
        let j = await res.json();

        if (res.ok) {
          const chain = j.chain || [];
          const blockCount = chain.length;
          showStatus('ledgerStatus', `‚úÖ Blockchain has ${blockCount} block(s)`, 'success');

          // Calculate stats
          const modes = {};
          const residents = new Set();
          chain.forEach(b => {
            if (b.data) {
              modes[b.data.mode] = (modes[b.data.mode] || 0) + 1;
              residents.add(b.data.resident_id);
            }
          });

          document.getElementById('ledgerStats').innerHTML = `
            <div class="stat-item">
              <div class="stat-number">${blockCount}</div>
              <div class="stat-label">Total Blocks</div>
            </div>
            <div class="stat-item">
              <div class="stat-number">${residents.size}</div>
              <div class="stat-label">Unique Users</div>
            </div>
            <div class="stat-item">
              <div class="stat-number">${modes.qr || 0}</div>
              <div class="stat-label">QR Scans</div>
            </div>
            <div class="stat-item">
              <div class="stat-number">${modes.face || 0}</div>
              <div class="stat-label">Face Scans</div>
            </div>
          `;

          document.getElementById('ledgerOut').innerHTML = `<code>${formatJSON(j)}</code>`;
        } else {
          showStatus('ledgerStatus', `‚ùå Error loading ledger`, 'error');
        }
      } catch (err) {
        showStatus('ledgerStatus', `‚ùå Network error: ${err.message}`, 'error');
      } finally {
        btn.disabled = false;
      }
    });

    // ============ INITIALIZATION ============
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Dashboard ready. API:', API_BASE);
    });

    // Clean up camera on page unload
    window.addEventListener('beforeunload', () => {
      if (cameraStream) stopCamera();
    });
  </script>
</body>
</html>
  

  <script>
    // API Base URL - change if serving from different host
    const API_BASE = window.location.origin;
    
    // Utility: Show status message
    function showStatus(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      el.innerHTML = `<div class="status ${type}">${message}</div>`;
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    // Utility: Clear status message
    function clearStatus(elementId) {
      document.getElementById(elementId).innerHTML = '';
    }

    // Utility: Toggle visibility of form elements based on scan mode
    document.getElementById('scanMode').addEventListener('change', function() {
      const mode = this.value;
      document.getElementById('photoGroup').style.display = mode === 'face' ? 'block' : 'none';
      document.getElementById('audioGroup').style.display = mode === 'voice' ? 'block' : 'none';
    });

    // Register Resident
    document.getElementById('regForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const btn = document.getElementById('btnRegister');
      btn.disabled = true;
      showStatus('regStatus', 'Processing registration...', 'loading');
      
      try {
        let f = new FormData(e.target);
        console.log('Sending registration request to:', `${API_BASE}/api/register`);
        let res = await fetch(`${API_BASE}/api/register`, {method:'POST', body: f});
        let j = await res.json();
        
        if (res.ok) {
          showStatus('regStatus', `‚úÖ Resident "${j.resident.name}" registered successfully! Room: ${j.resident.room}`, 'success');
          document.getElementById('regOut').innerText = JSON.stringify(j, null, 2);
          e.target.reset();
        } else {
          showStatus('regStatus', `‚ùå Error: ${j.error || 'Registration failed'}`, 'error');
          document.getElementById('regOut').innerText = JSON.stringify(j, null, 2);
        }
      } catch (err) {
        console.error('Registration network error:', err);
        showStatus('regStatus', `‚ùå Network error: ${err.message}\n(Check browser console for details)\nAPI URL: ${API_BASE}/api/register`, 'error');
      } finally {
        btn.disabled = false;
      }
    });

    // Load Residents
    document.getElementById('btnLoad').addEventListener('click', async ()=>{
      const btn = event.target;
      btn.disabled = true;
      showStatus('resStatus', 'Loading residents...', 'loading');
      
      try {
        console.log('Sending residents request to:', `${API_BASE}/api/residents`);
        let res = await fetch(`${API_BASE}/api/residents`);
        let j = await res.json();
        
        if (res.ok) {
          const count = j.residents ? j.residents.length : 0;
          showStatus('resStatus', `‚úÖ Loaded ${count} resident(s)`, 'success');
          document.getElementById('resList').innerText = JSON.stringify(j, null, 2);
        } else {
          showStatus('resStatus', `‚ùå Error loading residents`, 'error');
          document.getElementById('resList').innerText = JSON.stringify(j, null, 2);
        }
      } catch (err) {
        console.error('Residents network error:', err);
        showStatus('resStatus', `‚ùå Network error: ${err.message}\n(Check browser console for details)\nAPI URL: ${API_BASE}/api/residents`, 'error');
      } finally {
        btn.disabled = false;
      }
    });

    // Convert file to Base64
    async function fileToBase64(file){
      return new Promise((ok,err)=>{
        const r=new FileReader();
        r.onload = ()=> ok(r.result.split(',')[1]);
        r.onerror = err;
        r.readAsDataURL(file);
      });
    }

    // Send Scan
    document.getElementById('btnScan').addEventListener('click', async ()=>{
      const btn = event.target;
      btn.disabled = true;
      showStatus('scanStatus', 'Processing scan...', 'loading');
      
      try {
        const rid = document.getElementById('scanRid').value;
        const mode = document.getElementById('scanMode').value;
        const photo = document.getElementById('scanPhoto').files[0];
        const audio = document.getElementById('scanAudio').files[0];
        
        // Validation
        if (!rid && mode !== 'qr') {
          showStatus('scanStatus', '‚ùå Resident ID required for face/voice mode', 'error');
          btn.disabled = false;
          return;
        }
        if (mode === 'face' && !photo) {
          showStatus('scanStatus', '‚ùå Photo required for face recognition', 'error');
          btn.disabled = false;
          return;
        }
        if (mode === 'voice' && !audio) {
          showStatus('scanStatus', '‚ùå Audio required for voice recognition', 'error');
          btn.disabled = false;
          return;
        }
        
        let payload = { mode };
        if(rid) payload.resident_id = rid;
        if(mode=='face' && photo){
          payload.photo_b64 = await fileToBase64(photo);
        }
        if(mode=='voice' && audio){
          payload.audio_b64 = await fileToBase64(audio);
        }
        
        console.log('Sending scan request to:', `${API_BASE}/api/scan`);
        let res = await fetch(`${API_BASE}/api/scan`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        let j = await res.json();
        
        if (res.ok && j.ok) {
          showStatus('scanStatus', `‚úÖ Access granted for ${j.event.name}`, 'success');
        } else if (res.ok && !j.ok) {
          showStatus('scanStatus', `‚ùå Access denied - biometric mismatch`, 'error');
        } else {
          showStatus('scanStatus', `‚ùå Error: ${j.error || 'Scan failed'}`, 'error');
        }
        document.getElementById('scanOut').innerText = JSON.stringify(j, null, 2);
      } catch (err) {
        console.error('Scan network error:', err);
        showStatus('scanStatus', `‚ùå Network error: ${err.message}\n(Check browser console for details)\nAPI URL: ${API_BASE}/api/scan`, 'error');
      } finally {
        btn.disabled = false;
      }
    });

    // Load Ledger
    document.getElementById('btnLedger').addEventListener('click', async ()=>{
      const btn = event.target;
      btn.disabled = true;
      showStatus('ledgerStatus', 'Loading ledger...', 'loading');
      
      try {
        console.log('Sending ledger request to:', `${API_BASE}/api/ledger`);
        let res = await fetch(`${API_BASE}/api/ledger`);
        let j = await res.json();
        
        if (res.ok) {
          const blockCount = j.chain ? j.chain.length : 0;
          showStatus('ledgerStatus', `‚úÖ Blockchain has ${blockCount} block(s)`, 'success');
          document.getElementById('ledgerOut').innerText = JSON.stringify(j, null, 2);
        } else {
          showStatus('ledgerStatus', `‚ùå Error loading ledger`, 'error');
          document.getElementById('ledgerOut').innerText = JSON.stringify(j, null, 2);
        }
      } catch (err) {
        console.error('Ledger network error:', err);
        showStatus('ledgerStatus', `‚ùå Network error: ${err.message}\n(Check browser console for details)\nAPI URL: ${API_BASE}/api/ledger`, 'error');
      } finally {
        btn.disabled = false;
      }
    });
    
    // Initialize - log that page loaded and API is available
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Dashboard loaded. API Base:', API_BASE);
      console.log('Making test connection to API...');
      fetch(`${API_BASE}/api/residents`)
        .then(r => r.json())
        .then(d => console.log('‚úÖ API Connection OK:', d))
        .catch(e => console.error('‚ùå API Connection Error:', e));
    });
  </script>
</body>
</html>
